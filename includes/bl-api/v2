<h1 id="api-v2-reference">Api V2 reference</h1>

<p>You can use Api V2 fully, only when your schema is ready to support it.</p>

<h2 id="authentication">Authentication</h2>

<p>All of the endpoints require a single authentication header.</p>

<ul>
<li><code class="prettyprint">X-Member-Token</code> represents SMS pass code sent to the member and allows to manage his own profile only. To trigger that SMS use <code class="prettyprint">/send_token</code> call.</li>
<li><code class="prettyprint">X-Customer-Public-Token</code> is used for endpoints that are not sensitive (not destructive and do not leak any personal data). Currently:

<ul>
<li>Get schema</li>
<li>Send token</li>
<li>Check if member exists</li>
</ul></li>
<li><code class="prettyprint">X-Customer-Private-Token</code> can be used for batch operations on any member of the customer&rsquo;s loyalty club.
It could be used for all operations that allow authentication with <code class="prettyprint">X-Customer-Public-Token</code>.
It should be used only on backend and never exposed in frontend code.</li>
</ul>

<p>If you miss your authentication tokens, please <a href="http://boostcom.no">let us know</a>.</p>

<aside class="notice">
You must use only one header in each request.
</aside>

<h2 id="product-name">Product name</h2>

<p>Each system that is communicating with us should uniquely identify itself so it is possible to distinguish optin/update channels.
That will allow further targeting members by communication channel.
For that we use product name and header <code class="prettyprint">X-Product-Name</code> is intended to provide the necessary granularity.</p>

<p>If you miss your product name, please <a href="http://boostcom.no">let us know</a>.</p>

<aside class="warning">
Product Name header is required in each request!
<br>
When it is missing or it has incorrect value, then <code>401 Unauthorized</code> HTTP code and empty response body are returned.
</aside>

<h2 id="get-loyalty-clubs-schema">Get loyalty club&rsquo;s schema</h2>
<pre class="highlight shell tab-shell"><code>curl <span class="s2">"https://connect.bstcm.no/api/v2/loyalty_clubs/:loyalty_club_slug/member_schema"</span> <span class="se">\</span>
  -H <span class="s2">"X-Customer-Public-Token: alphanumeric_string"</span> <span class="se">\</span>
  -H <span class="s2">"X-Product-Name: custom-product-name"</span>
</code></pre>
<blockquote>
<p>When successful, the above command returns JSON structured like this:</p>
</blockquote>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"$schema"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://json-schema.org/draft-04/schema#"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"languages"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"en"</span><span class="p">,</span><span class="w"> </span><span class="s2">"no"</span><span class="p">],</span><span class="w">
  </span><span class="s2">"default_language"</span><span class="p">:</span><span class="w"> </span><span class="s2">"no"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"v2"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"first_name"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"last_name"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"birthday"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"format"</span><span class="p">:</span><span class="w"> </span><span class="s2">"date"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"interests"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"enum"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"bikes_and_cars"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"sportwear"</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="s2">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"first_name"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"last_name"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"birthday"</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>Properties for members are defined as part of the loyalty club they belong to.
To describe member properties we use <a href="http://json-schema.org/documentation.html">JSON Schema</a> definition.
Properties of each member must conform to the defined schema.
We support <strong>JSON schema Draft V4</strong> with format extension for <code class="prettyprint">date</code> (YYYY-MM-DD).</p>

<p>Keys explanation:</p>

<ul>
<li><code class="prettyprint">languages</code> [Array of strings] - array of languages set up in loyalty club</li>
<li><code class="prettyprint">default_language</code> [string] - default language used in loyalty club and also used for mappings to Api v2</li>
<li><code class="prettyprint">version</code> [string] - version of schema, currently the newest is <code class="prettyprint">v2</code></li>
<li><code class="prettyprint">products</code> [Object] - properties scoping and ordering by product name, default one is <code class="prettyprint">default</code></li>
<li><code class="prettyprint">required</code> [Array of strings] - required properties for member</li>
</ul>

<h3 id="http-request">HTTP Request</h3>

<p><strong>GET</strong> <code class="prettyprint">api/v2/loyalty_clubs/:loyalty_club_slug/member_schema</code></p>

<table><thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>loyalty_club_slug</td>
<td>unique slugified name of the loyalty club. Example: <code class="prettyprint">boosters</code>.</td>
</tr>
</tbody></table>

<aside class="notice">
Authentication only with <code>X-Customer-Public-Token</code>.
</aside>

<h2 id="send-member-token">Send member token</h2>

<p><strong>Member tokens</strong> are used to authenticate actions on particular members.
<strong>Member token</strong> could be issued even before registering enduser as a member in community.
In that case we create temporary token that is valid till end of day.
That <strong>member token</strong> could be used to authenticate <em>Create Member</em> action described below.</p>

<p>It sends member token to the user via SMS.</p>

<p>It can be used multiple times.</p>

<p>If msisdn is not valid, then <code class="prettyprint">400 Bad Request</code> is returned.</p>

<h3 id="http-request">HTTP Request</h3>

<p><strong>POST</strong> <code class="prettyprint">api/v2/loyalty_clubs/:loyalty_club_slug/members/:msisdn/send_token</code></p>

<h3 id="url-parameters">URL Parameters</h3>

<table><thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>loyalty_club_slug</td>
<td>unique slugified name of the loyalty club. Example: <code class="prettyprint">boosters</code>.</td>
</tr>
<tr>
<td>msisdn</td>
<td>unique member&rsquo;s msisdn as defined by E.164 (described above) Example: <code class="prettyprint">4740485124</code>.</td>
</tr>
</tbody></table>

<aside class="notice">
Authentication with <code>X-Customer-Public-Token</code> or <code>X-Customer-Private-Token</code>.
</aside>

<h2 id="check-if-member-exists">Check if member exists</h2>
<pre class="highlight shell tab-shell"><code>curl -I <span class="s2">"https://connect.bstcm.no/api/v2/loyalty_clubs/:loyalty_club_slug/members/:msisdn"</span> <span class="se">\</span>
  -H <span class="s2">"X-Customer-Public-Token: alphanumeric_string"</span> <span class="se">\</span>
  -H <span class="s2">"X-Product-Name: custom-product-name"</span>
</code></pre>
<blockquote>
<p>Response will be 200 or 404 code.</p>
</blockquote>

<p>It can be used to check if member is in loyalty club or not.</p>

<h3 id="http-request">HTTP Request</h3>

<p><strong>HEAD</strong> <code class="prettyprint">api/v2/loyalty_clubs/:loyalty_club_slug/members/:msisdn</code></p>

<h3 id="url-parameters">URL Parameters</h3>

<table><thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>loyalty_club_slug</td>
<td>unique slugified name of the loyalty club. Example: <code class="prettyprint">boosters</code>.</td>
</tr>
<tr>
<td>msisdn</td>
<td>unique member&rsquo;s msisdn as defined by E.164 (described above) Example: <code class="prettyprint">4740485124</code>.</td>
</tr>
</tbody></table>

<h3 id="response-codes">Response codes</h3>

<ul>
<li><strong>200</strong> - member exists</li>
<li><strong>404 Not found</strong> - member with <code class="prettyprint">msisdn</code> not found or it is invalid</li>
</ul>

<aside class="notice">
Authentication with <code>X-Customer-Public-Token</code>.
</aside>

<h2 id="get-member">Get member</h2>
<pre class="highlight shell tab-shell"><code>curl <span class="s2">"https://connect.bstcm.no/api/v2/loyalty_clubs/:loyalty_club_slug/members/:msisdn"</span> <span class="se">\</span>
  -H <span class="s2">"X-Customer-Private-Token: alphanumeric_string"</span> <span class="se">\</span>
  -H <span class="s2">"X-Product-Name: custom-product-name"</span>
</code></pre>
<blockquote>
<p>When successful, the above command returns JSON structured like this:</p>
</blockquote>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">42</span><span class="p">,</span><span class="w">
  </span><span class="s2">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"first_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Ola"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"last_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Nordmann"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"birthday"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1990-10-23"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"interests"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="s2">"bikes_and_cars"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"sportwear"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="s2">"child_birth_years"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="mi">2010</span><span class="p">,</span><span class="w">
      </span><span class="mi">2011</span><span class="p">,</span><span class="w">
      </span><span class="mi">2011</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="s2">"language"</span><span class="p">:</span><span class="w"> </span><span class="s2">"no"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="s2">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2017-01-19T10:07:08.336+01:00"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"updated_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2017-04-03T09:35:19.313+02:00"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>Fetches member&rsquo;s properties.</p>

<table><thead>
<tr>
<th>Key</th>
<th>Description</th>
<th>Type</th>
</tr>
</thead><tbody>
<tr>
<td>id</td>
<td>Member ID</td>
<td>integer</td>
</tr>
<tr>
<td>properties</td>
<td>Object with member&rsquo;s properties</td>
<td>JSON Object</td>
</tr>
<tr>
<td>properties[&lsquo;language&rsquo;]</td>
<td>Language used by user</td>
<td>string</td>
</tr>
<tr>
<td>created_at</td>
<td>Time when the user was firstly created</td>
<td>string</td>
</tr>
<tr>
<td>updated_at</td>
<td>Time when the user was last updated</td>
<td>string</td>
</tr>
</tbody></table>

<h3 id="http-request">HTTP Request</h3>

<p><strong>GET</strong> <code class="prettyprint">api/v2/loyalty_clubs/:loyalty_club_slug/members/:msisdn</code></p>

<h3 id="url-parameters">URL Parameters</h3>

<table><thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>loyalty_club_slug</td>
<td>unique slugified name of the loyalty club. Example: <code class="prettyprint">boosters</code>.</td>
</tr>
<tr>
<td>msisdn</td>
<td>unique member&rsquo;s msisdn as defined by E.164 (described above) Example: <code class="prettyprint">4740485124</code>.</td>
</tr>
</tbody></table>

<h3 id="responses">Responses</h3>

<ul>
<li><strong>200</strong> - success with member&rsquo;s properties in response body</li>
<li><strong>404 Not found</strong> - member with <code class="prettyprint">msisdn</code> not found or it is invalid</li>
</ul>

<aside class="notice">
Authentication with <code>X-Member-Token</code> and <code>X-Customer-Private-Token</code>.
</aside>

<h2 id="create-member">Create member</h2>

<p>Create member with given properties.</p>

<p>When invalid authentication token is provided response <code class="prettyprint">401 Unauthorized</code> is returned disregarding whether member exists or not.</p>

<h3 id="http-request">HTTP Request</h3>

<p><strong>PUT</strong> <code class="prettyprint">api/v2/loyalty_clubs/:loyalty_club_slug/members/:msisdn</code></p>

<h3 id="url-parameters">URL Parameters</h3>

<table><thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>loyalty_club_slug</td>
<td>unique slugified name of the loyalty club. Example: <code class="prettyprint">boosters</code>.</td>
</tr>
<tr>
<td>msisdn</td>
<td>unique member&rsquo;s msisdn as defined by E.164 (described above) Example: <code class="prettyprint">4740485124</code>.</td>
</tr>
</tbody></table>

<h3 id="put-json-parameters">PUT (JSON) Parameters</h3>

<table><thead>
<tr>
<th>Parameter</th>
<th>Description</th>
<th>Type</th>
</tr>
</thead><tbody>
<tr>
<td>properties</td>
<td>JSON with properties for member</td>
<td>JSON Object</td>
</tr>
<tr>
<td>properties[&lsquo;language&rsquo;]</td>
<td>Language used by user, if not set then &ldquo;default_language&rdquo; is taken from schema</td>
<td>string</td>
</tr>
<tr>
<td>send_welcome_message</td>
<td>If true, SMS welcome message will be send to member</td>
<td>Boolean</td>
</tr>
<tr>
<td>send_email_welcome_message</td>
<td>If true and emails configured in loyalty club, email welcome (verification) message will be send to member</td>
<td>Boolean</td>
</tr>
</tbody></table>

<aside class="notice">
There is possibility to have multiple SMS welcome messages. Sent will be the one that matches Product or default one.
</aside>

<h3 id="responses">Responses</h3>

<ul>
<li><strong>200</strong> - success with member&rsquo;s properties in response body</li>
<li><strong>400 Bad request</strong> - <code class="prettyprint">msisdn</code> is invalid or there are <a href="#validation-on-members">validation errors</a>.</li>
<li><strong>409 Conflict</strong> - member with <code class="prettyprint">msisdn</code> already exists in loyalty club</li>
</ul>

<aside class="notice">
Authentication with <code>X-Member-Token</code> and <code>X-Customer-Private-Token</code>.
</aside>

<h2 id="update-member">Update member</h2>

<p>Update member&rsquo;s properties with given ones.</p>

<p>It is intended for partial updates - not given properties are neither deleted nor overwritten.</p>

<h3 id="http-request">HTTP Request</h3>

<p><strong>PATCH</strong> <code class="prettyprint">api/v2/loyalty_clubs/:loyalty_club_slug/members/:msisdn</code></p>

<h3 id="url-parameters">URL Parameters</h3>

<table><thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>loyalty_club_slug</td>
<td>unique slugified name of the loyalty club. Example: <code class="prettyprint">boosters</code>.</td>
</tr>
<tr>
<td>msisdn</td>
<td>unique member&rsquo;s msisdn as defined by E.164 (described above) Example: <code class="prettyprint">4740485124</code>.</td>
</tr>
</tbody></table>

<h3 id="patch-json-parameters">PATCH (JSON) Parameters</h3>

<table><thead>
<tr>
<th>Parameter</th>
<th>Description</th>
<th>Type</th>
</tr>
</thead><tbody>
<tr>
<td>properties</td>
<td>JSON with properties for member</td>
<td>JSON Object</td>
</tr>
</tbody></table>

<h3 id="responses">Responses</h3>

<ul>
<li><strong>200</strong> - success with member&rsquo;s properties in response body</li>
<li><strong>400 Bad request</strong> - <code class="prettyprint">msisdn</code> is invalid or there are <a href="#validation-on-members">validation errors</a>.</li>
<li><strong>404 Not found</strong> - member with <code class="prettyprint">msisdn</code> not found or it is invalid</li>
</ul>

<aside class="notice">
Authentication with <code>X-Member-Token</code> and <code>X-Customer-Private-Token</code>.
</aside>

<h2 id="remove-member">Remove member</h2>

<p>Removes member from loyalty club.</p>

<p>It is possible to trigger optout message by setting <code class="prettyprint">send_unsubscribe_message=true</code> query string parameter.</p>

<h3 id="http-request">HTTP Request</h3>
<pre class="highlight shell tab-shell"><code>curl -X DELETE -H <span class="s2">"X-Customer-Private-Token: alphanumeric_string"</span> <span class="se">\</span>
     -H <span class="s2">"X-Product-Name: custom-product-name"</span> <span class="se">\</span>
     <span class="s2">"https://connect.bstcm.no/api/v2/loyalty_clubs/:loyalty_club_slug/member_schema"</span>
</code></pre>
<blockquote>
<p>Successful removal is indicated by response code 200</p>
</blockquote>

<p><strong>DELETE</strong> <code class="prettyprint">api/v2/loyalty_clubs/:loyalty_club_slug/members/:msisdn</code></p>

<h3 id="url-parameters">URL Parameters</h3>

<table><thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>loyalty_club_slug</td>
<td>unique slugified name of the loyalty club. Example: <code class="prettyprint">boosters</code>.</td>
</tr>
<tr>
<td>msisdn</td>
<td>unique member&rsquo;s msisdn as defined by E.164 (described above) Example: <code class="prettyprint">4740485124</code>.</td>
</tr>
</tbody></table>

<h3 id="query-parameters">Query Parameters</h3>

<table><thead>
<tr>
<th>Parameter</th>
<th>Description</th>
<th>Type</th>
</tr>
</thead><tbody>
<tr>
<td>send_unsubscribe_message</td>
<td>If true, optout message will be send to member. Example: <code class="prettyprint">true</code>.</td>
<td>Boolean</td>
</tr>
</tbody></table>

<h3 id="responses">Responses</h3>

<ul>
<li><strong>200</strong> - success with member&rsquo;s properties in response body</li>
<li><strong>404 Not found</strong> - member with <code class="prettyprint">msisdn</code> not found or it is invalid</li>
</ul>

<aside class="notice">
Authentication with <code>X-Member-Token</code> and <code>X-Customer-Private-Token</code>.
</aside>
